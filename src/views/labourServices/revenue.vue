<template>  <el-main class="bg_white">    <el-button class="goExit" type="primary" size="small" round @click="goExit">关闭</el-button>    <el-card class="box-card">      <template v-for="(item, i) in funList">        <el-button class="c_rela" v-if="item.key === 'export'" :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">          {{ item.name }}          <input ref="fileInput" class="fileInput c_w c_h c_opacity" :class="!item.disabled && isExport ? '' : 'c_no_pointer'" type="file" @change="importExcel" />        </el-button>        <el-button v-else-if="item.key === 'card'" :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">          {{ isCardTab ? '列表显示' : '卡片显示' }}        </el-button>        <el-button v-else :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">{{ item.name }}</el-button>      </template>    </el-card>    <div class="print-content">      <!--表头-->      <el-card>        <!--!!!!!!!待办============-->        <template v-if="headerState==='dealtSelect'">          <div v-show="isCardTab" class="">            <!--表头卡片-->            <el-form label-position="left" inline class="demo-table-expand">              <template v-for="(item,i) in tableHeaderParam.detailList_workflow">                <template v-if="item.key === 'vbillstatus'">                  <el-form-item :label="item.name">                    <el-select style="width: 100px" size="small" readonly :disabled="true" v-model="headerTableSelectionData[item.key]">                      <el-option                        v-for="item in dataSource.vbillstatusListMap"                        :key="item.value"                        :label="item.label"                        :value="item.value">                      </el-option>                    </el-select>                  </el-form-item>                </template>                <template v-else-if="item.type === 'date'">                  <el-form-item :label="item.name">                    <el-date-picker                      style="width: 130px;"                      :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled"                      v-model="headerTableSelectionData[item.key]"                      size="small"                      type="date"                      placeholder="选择日期">                    </el-date-picker>                  </el-form-item>                </template>                <template v-else-if="item.type === 'deptname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDeptname"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'submittername'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleSubmittername"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'isinvoice'">                  <el-form-item :label="item.name">                    <el-select                      style="width: 100px"                      size="small"                      readonly                      :disabled="item.disabled || isHeaderDetailDisabled"                      v-model="headerTableSelectionData[item.key]"                    >                      <el-option                        v-for="item in dataSource.isinvoiceListMap"                        :key="item.value"                        :label="item.label"                        :value="item.value">                      </el-option>                    </el-select>                  </el-form-item>                </template>                <template v-else-if="item.type === 'operatorname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleOperatorname"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'financename'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleFinancename"></el-input>                  </el-form-item>                </template>                <template v-else>                  <el-form-item :label="item.name">                    <el-input size="small" :disabled="item.disabled || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>              </template>            </el-form>          </div>          <div v-show="!isCardTab" class="table-header">            <!--表头列表-->            <el-table              ref="headerTable"              class="c_h"              :data="tableHeaderData"              :row-key="tableHeaderParam.rowKey"              :expand-row-keys="tableHeaderParam.expandRowKeys"              size="small"              height="300"              highlight-current-row              @selection-change="headerSelectionChange"            >              <el-table-column type="selection" width="55"></el-table-column>              <template v-for="(item, i) in tableHeaderParam.list_workflow">                <template v-if="item.key === 'vbillstatus'">                  <el-table-column :key="i" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ dataSource.vbillstatusList[scope.row[item.key]] }}                    </template>                  </el-table-column>                </template>                <template v-else-if="item.key === 'isinvoice'">                  <el-table-column :key="i" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ scope.row[item.key] == 1 ? '是' : scope.row[item.key] == 2 ? '否' : '冲以前年度挂账' }}                    </template>                  </el-table-column>                </template>                <template v-else>                  <el-table-column :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>                </template>              </template>            </el-table>          </div>        </template>        <!--!!!!!!!查询=============-->        <template v-else>          <div v-show="isCardTab" class="">            <!--表头卡片-->            <el-form label-position="left" inline class="demo-table-expand">              <template v-for="(item,i) in tableHeaderParam.detailList_query">                <template v-if="item.key === 'vbillstatus'">                  <el-form-item :label="item.name">                    <el-select style="width: 100px" size="small" readonly :disabled="true" v-model="headerTableSelectionData[item.key]">                      <el-option                        v-for="item in dataSource.vbillstatusListMap"                        :key="item.value"                        :label="item.label"                        :value="item.value">                      </el-option>                    </el-select>                  </el-form-item>                </template>                <template v-else-if="item.type === 'date'">                  <el-form-item :label="item.name">                    <el-date-picker                      style="width: 130px;"                      :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled"                      v-model="headerTableSelectionData[item.key]"                      size="small"                      type="date"                      placeholder="选择日期">                    </el-date-picker>                  </el-form-item>                </template>                <template v-else-if="item.type === 'deptname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDeptname"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'submittername'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleSubmittername"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'isinvoice'">                  <el-form-item :label="item.name">                    <el-select                      style="width: 100px"                      size="small"                      readonly                      :disabled="item.disabled || isHeaderDetailDisabled"                      v-model="headerTableSelectionData[item.key]"                    >                      <el-option                        v-for="item in dataSource.isinvoiceListMap"                        :key="item.value"                        :label="item.label"                        :value="item.value">                      </el-option>                    </el-select>                  </el-form-item>                </template>                <template v-else-if="item.type === 'operatorname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleOperatorname"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'financename'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleFinancename"></el-input>                  </el-form-item>                </template>                <template v-else>                  <el-form-item :label="item.name">                    <el-input size="small" :disabled="item.disabled || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>              </template>            </el-form>          </div>          <div v-show="!isCardTab" class="table-header c_h">            <!--表头列表-->            <el-table              ref="headerTable"              class="c_h"              :data="tableHeaderData"              :row-key="tableHeaderParam.rowKey"              :expand-row-keys="tableHeaderParam.expandRowKeys"              size="small"              height="250"              highlight-current-row              @selection-change="headerSelectionChange"            >              <el-table-column type="selection" width="55"></el-table-column>              <template v-for="(item, i) in tableHeaderParam.list_query">                <template v-if="item.key === 'vbillstatus'">                  <el-table-column :key="i" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ dataSource.vbillstatusList[scope.row[item.key]] }}                    </template>                  </el-table-column>                </template>                <template v-else-if="item.key === 'isinvoice'">                  <el-table-column :key="i" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ scope.row[item.key] == 1 ? '是' : scope.row[item.key] == 2 ? '否' : '冲以前年度挂账' }}                    </template>                  </el-table-column>                </template>                <template v-else>                  <el-table-column :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>                </template>              </template>            </el-table>          </div>        </template>      </el-card>      <!--表体-->      <el-card class="c_m_t_n" style="min-height: 200px;">        <el-table          class="c_h"          size="small"          max-height="300"          show-summary          :summary-method="getSummaries"          :data="tableBodyData"        >          <template v-if="headerState==='add' || headerState==='edit'" slot="empty">            <el-button              v-show="['add', 'edit'].includes(headerState)"              size="mini"              type="primary"              @click="tableBodyAdd">新增</el-button>          </template>          <template v-for="(item, i) in tableBodyParam.list">            <el-table-column v-if="item.key === 'rowno'" :key="i" :width="item.width" :label="item.name" :prop="item.key">              <template slot-scope="scope">                {{ scope.$index + 1}}              </template>            </el-table-column>            <el-table-column v-else :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>          </template>          <el-table-column :fixed="['add', 'edit'].includes(headerState)? 'right': false" width="220" label="操作">            <template slot-scope="scope">              <!--v-show="['add', 'edit'].includes(headerState) && (scope.$index+1 === tableBodyData.length)"-->              <el-button                v-show="['add', 'edit'].includes(headerState)"                size="mini"                type="primary"                @click="tableBodyAdd(scope.$index, scope.row)">新增</el-button>              <el-button                v-show="['add', 'edit'].includes(headerState)"                size="mini"                type="primary"                @click="tableBodyEdit(scope.$index, scope.row)">编辑</el-button>              <el-button                v-show="['add', 'edit'].includes(headerState)"                size="mini"                type="danger"                @click="tableBodyDelete(scope.$index, scope.row)">删除</el-button>            </template>          </el-table-column>        </el-table>      </el-card>    </div>    <!-- 查询条件弹框 -->    <query-select ref="querySelect" @confirm="confirmHeaderQuery"></query-select>    <!-- 审批条件弹框 -->    <approval-select ref="approvalSelect" @confirm="confirmHeaderApprove"></approval-select>    <!--项目选择-->    <!--<project-select ref="projectSelect" @confirm="confirmTree"></project-select>-->    <!--费用承担部门 -->    <!--<def1name-select ref="def1nameSelect" @confirm="confirmDef1name"></def1name-select>-->    <!--部门 -->    <deptname-select ref="deptnameSelect" @confirm="confirmDeptname"></deptname-select>    <!--提交人-->    <submittername-select ref="submitternameSelect" @confirm="confirmSubmittername"></submittername-select>    <!-- 表体新增，编辑弹框 -->    <table-body-select ref="tableBodySelect" @confirm="confirmBodyOpera"></table-body-select>    <!--指派经办人 -->    <operatorname-select ref="operatornameSelect" rolecode="jbr" title="指派经办人" @confirm="confirmOperatorname"></operatorname-select>    <!--指派财务 -->    <financename-select ref="financenameSelect" title="指派财务" @confirm="confirmFinancename"></financename-select>  </el-main></template><script>  import XLSX from 'xlsx'  import querySelect from './components/select'  import approvalSelect from './components/approval'  // import projectSelect from './components/project'  import deptnameSelect from './components/bxbmSelect'  import submitternameSelect from './components/bxrSelect'  // import def1nameSelect from './components/bxbmSelect'  import tableBodySelect from './components/revenue/tableBodySelect'  // import tableBodyFySelect from './components/tableBodyFySelect'  import operatornameSelect from './components/def1name'  import financenameSelect from './components/def1name'  export default {    name: "revenue",    components: {      querySelect,      approvalSelect,      // projectSelect,      deptnameSelect,      submitternameSelect,      // def1nameSelect,      tableBodySelect,      // tableBodyFySelect,      operatornameSelect,      financenameSelect    },    mixins: [],    data() {      return {        timer: undefined,        isCardTab: false,        // 功能菜单        // -- [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        funList: [          { name: '查询', type: 'primary', disabled: false, isHide: false, key: 'select', handle: 'selectHeader' },          { name: '修改', type: 'primary', disabled: false, isHide: false, key: 'edit', handle: 'editHeader' },          { name: '增加', type: 'primary', disabled: false, isHide: false, key: 'add', handle: 'addHeader' },          { name: '删除', type: 'primary', disabled: false, isHide: false, key: 'del', handle: 'delHeader' },          { name: '取消', type: 'primary', disabled: false, isHide: false, key: 'cancel', handle: 'cancelHeader' },          { name: '提交', type: 'primary', disabled: false, isHide: false, key: 'confirm', handle: 'confirmHeader' },          { name: '审批', type: 'primary', disabled: false, isHide: false, key: 'approval', handle: 'approvalHeader' },          // { name: '联查审批情况', type: 'primary', disabled: false, isHide: false, key: 'joinApproval', handle: 'jointApprovalHeader' },          { name: '待办查询', type: 'primary', disabled: false, isHide: false, key: 'dealtSelect', handle: 'dealtSelectHeader' },          { name: '导入', type: 'primary', disabled: false, isHide: false, key: 'export', handle: 'exportHeader' },          { name: '列表显示', type: 'primary', disabled: false, isHide: false, key: 'card', handle: 'tabCard' },          // { name: '下载模板', type: 'primary', disabled: false, isHide: false, key: 'download', handle: 'download' },          // { name: '导出', type: 'primary', disabled: false, isHide: false, key: 'exportExccel', handle: 'exportExccel' },          { name: '打印', type: 'primary', disabled: false, isHide: false, key: 'print', handle: 'print' },        ],        // api        api: {          // 劳务+差旅 公共接口          // getData: '/api/service/GlLaborwage?userid=0001F8100000000000S1',          getData: '/service/GlLaborwage?userid=' + this.$route.query.userid,          // 差旅 接口          // travelExpense: '/api/service/GlTravelbx?userid=0001F8100000000000S1',          travelExpense: '/service/GlTravelbx?userid=' + this.$route.query.userid,          // 收入确认单 接口          // revenue: '/api/service/income?userid=0001F8100000000000S1',          revenue: '/service/income?userid=' + this.$route.query.userid,        },        dataSource: {          isinvoiceListMap: [            { value: 1, label: '是' },            { value: 2, label: '否' },            { value: 3, label: '冲以前年度挂账' }          ],          vbillstatusListMap: [            { value: 0, label: '审批不通过' },            { value: 1, label: '审核通过' },            { value: 2, label: '审批进行中' },            { value: 3, label: '提交' },            { value: 8,  label: '自由' }          ],          vbillstatusList: {            0: '审批不通过',            1: '审核通过',            2: '审批进行中',            3: '提交',            8:  '自由'          },        },        // 表头参数        // -- 表头状态        headerState: 'select',        // -- 请求参数        //  --query:单据查询        //  --add:新增单据        //  --workflow:待办查询        //  --approve:审批单据        headerSearchData: {          action: 'query',          data: {}        },        // -- 表格参数        tableHeaderParam: {          list: [],          list_query: [            { name: '单据编号', key: 'vbillno', width: 130, isUse: true },            { name: '单据日期', key: 'dbilldate', isUse: true },            { name: '部门', key: 'deptname', isUse: true },            { name: '提交人', key: 'submittername', isUse: true },            { name: '是否开票', key: 'isinvoice', isUse: true },            { name: '指派经办人', key: 'operatorname', isUse: true },            { name: '指派财务', key: 'financename', isUse: true },            { name: '单据状态', key: 'vbillstatus', isUse: true },            { name: '合计', key: 'total', isUse: true },            { name: '备注', key: 'memo', isUse: true }          ],          list_workflow: [            { name: '单据编号', key: 'vbillno', width: 130, isUse: true },            { name: '单据日期', key: 'dbilldate', isUse: true },            { name: '部门', key: 'deptname', isUse: true },            { name: '提交人', key: 'submittername', isUse: true },            { name: '是否开票', key: 'isinvoice', isUse: true },            { name: '指派经办人', key: 'operatorname', width: 220, isUse: true },            { name: '指派财务', key: 'financename', width: 220, isUse: true },            { name: '单据状态', key: 'vbillstatus', isUse: true },            { name: '合计', key: 'total', isUse: true },            { name: '备注', key: 'memo', isUse: true }          ],          detailList: [],          detailList_query: [            { name: '单据编号', key: 'vbillno', width: 120, disabled: true, isUse: false },            { name: '单据日期', key: 'dbilldate', type: 'date', disabled: false, isUse: true },            { name: '部门', key: 'deptname', type: 'deptname', disabled: false, isUse: true },            { name: '提交人', key: 'submittername', type: 'submittername', disabled: false, isUse: true },            { name: '是否开票', key: 'isinvoice', type: 'isinvoice', disabled: false, isUse: true },            { name: '指派经办人', key: 'operatorname', type: 'operatorname', disabled: false, isUse: true },            { name: '指派财务', key: 'financename', type: 'financename', disabled: false, isUse: true },            { name: '单据状态', key: 'vbillstatus', isUse: true },            { name: '合计', key: 'total', disabled: true, isUse: true },            { name: '备注', key: 'memo', disabled: false, isUse: true }          ],          detailList_workflow: [            { name: '单据编号', key: 'vbillno', width: 120, disabled: true, isUse: false },            { name: '单据日期', key: 'dbilldate', type: 'date', disabled: true, isUse: true },            { name: '部门', key: 'deptname', type: 'deptname', disabled: false, isUse: true },            { name: '提交人', key: 'submittername', type: 'submittername', disabled: false, isUse: true },            { name: '是否开票', key: 'isinvoice', type: 'isinvoice', disabled: false, isUse: true },            { name: '指派经办人', key: 'operatorname', type: 'operatorname', disabled: false, isUse: true },            { name: '指派财务', key: 'financename', type: 'financename', disabled: false, isUse: true },            { name: '单据状态', key: 'vbillstatus', disabled: true, isUse: true },            { name: '合计', key: 'total', disabled: true, isUse: true },            { name: '备注', key: 'memo', disabled: false, isUse: true }          ],          rowKey: 'cbillid',          expandRowKeys: []        },        // -- 表格列表数据        tableHeaderData: [],        // -- 当前被选中表头项 | 表体请求参数        headerTableSelectionData: {},        // 表体参数        // -- 表格参数        tableBodyParam: {          list: [            { name: '客商', key: 'custname', isUse: true },            { name: '项目', key: 'jobname', isUse: true },            { name: '金额(元)', key: 'amount', isUse: true },            { name: '备注', key: 'memo', isUse: true }          ]        },        // -- 表格列表数据        tableBodyData: [],        // 表尾参数        // -- 表单参数        footerParam: {          form: [            // { name: '经办人', key: 'operator', isUse: true },            // { name: '最终修改人', key: 'clastmodifier', isUse: true },            // { name: '审核人', key: 'approver', isUse: true },            // { name: '单据状态', key: 'vbillstatus', isUse: true },          ]        },        // -- 表单数据        footerData: {          voperatorid: '录入人',          clastmodifier: '最终修改人',          vapproveid: '审核人',          vbillstatus: '单据状态',        },      }    },    computed: {      // 是否可以编辑详情卡片      isHeaderDetailDisabled(props) {        // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        return !['edit', 'add'].includes(this.headerState)      },      // 是否可以使用导入功能      isExport() {        // 未禁用        // 有唯一key值        // 属于编辑态和新增态        return (['edit', 'add'].includes(this.headerState))      }    },    watch: {      headerState(val) {        switch (val) {          case 'select':            this.setFunAuth([ 'select', 'edit', 'add', 'del', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])            break;          case 'edit':            this.setFunAuth([ 'cancel', 'confirm', 'export'])            break;          case 'add':            this.setFunAuth([ 'cancel', 'confirm', 'export', 'download', 'exportExccel', 'print'])            break;          case 'joinApproval':            this.setFunAuth([ 'select', 'edit', 'add', 'del', 'approval', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])            break;          case 'dealtSelect':            this.setFunAuth([ 'select', 'edit', 'add', 'cancel', 'approval', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])            break;        }      }    },    mounted() {      this.setFunAuth([ 'select', 'edit', 'add', 'del', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])      // this.headerState = 'select'      // this.selectHeader()    },    methods: {      // 功能菜单事件      handleFun(item) {        let row = this.headerTableSelectionData;        switch (item.key) {          case 'select':            this.headerState = item.key;            this[item.handle](row);            break;          case 'edit':            if (!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this.headerState = item.key;            this[item.handle](row);            break;          case 'add':            this.headerState = item.key;            this[item.handle](row);            break;          case 'cancel':            this[item.handle](row);            break;          case 'confirm':            this[item.handle](row);            break;          // case 'del':          //   this[item.handle](row);          //   break;          // case 'approval': // 审批          //   this[item.handle](row);          //   break;          // case 'joinApproval': // 联查审批情况          //   this[item.handle](row);          //   break;          case 'export':            if (this.headerState === 'add') {              this[item.handle](row);              return;            } else if(!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this[item.handle](row);            break;          case 'dealtSelect':            this.headerState = item.key;            this[item.handle](row);            break;          // case 'card':          //   this[item.handle](row);          //   break;          case 'download':            this[item.handle](row);            break;          case 'print':            this[item.handle](row);            break;          case 'exportExccel':            this[item.handle](row);            break;          default:            if (!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this[item.handle](row);        }      },      // 功能菜单权限控制      setFunAuth(list = [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export', 'card']) {        // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        this.funList = this.funList.map(item => {          item.disabled = !list.includes(item.key)          return item        })      },      // 查询      selectHeader(row) {        this.$refs.querySelect.open(row)      },      confirmHeaderQuery(data) {        // 返回列表显示        this.isCardTab = false        // 清空表体        this.tableBodyData = []        // 查询条件        this.headerSearchData = data        this.getHeaderData()      },      // 修改      editHeader(row) {        // 禁用其他操作        this.setFunAuth(['cancel', 'confirm', 'export'])        // 切换到卡片新增        this.isCardTab = true      },      // 增加      addHeader(row) {        // 取消其他选中        this.clearSelection();        // 清空表头选中数据,设置默认值        this.headerTableSelectionData = {          // zy: "代发差旅费",          dbilldate: this.$tool.formatDate('', 1)        }        // 获取当前登陆人        this.getUser(() => {          // 清空表体          this.tableBodyData = []          // 禁用其他操作          this.setFunAuth(['cancel', 'confirm', 'export'])          // 切换到卡片新增          this.isCardTab = true        })      },      // 删除      delHeader(row) {        const self = this        this.$confirm('确定要删除吗?', '删除提示', {          confirmButtonText: '确定',          cancelButtonText: '取消',          type: 'warning'        }).then(() => {          let data = {            action: 'del',            data: {              cbillid: row.cbillid            }          }          data.data = JSON.stringify(data.data)          this.$ajax.postform(this.api.revenue, data, res => {            if (self.judgeValue(res)) {              self.$message({                type: 'success',                message: '删除成功!',                duration: 1000              });              // 返回列表状态              this.headerState = 'select'              // 返回列表显示              this.isCardTab = false              // 刷新表头              self.getHeaderData()            }          })        });      },      // 取消      cancelHeader(row) {        // 取消权限控制        this.setFunAuth()        if (this.headerState === 'add') {          // 清空表体          this.tableHeaderData = []          this.tableBodyData = []          // 刷新表头          this.getHeaderData()        }        // 返回列表状态        this.headerState = 'select'        // 返回列表显示        this.isCardTab = false      },      // 提交      confirmHeader(row) {        if (!['edit', 'add'].includes(this.headerState)){          return this.$message({ type: 'warn', message: '没有需要提交的内容', duration: 1000 });        }        // if (this.headerTableSelectionData.totalSk !== this.headerTableSelectionData.totalFy) {        //   return this.$message({ type: 'warn', message: '费用明细金额与收款人金额总计不同,请仔细核对!', duration: 1000 });        // }        let data = {          action: 'add',          data: {            head: {              ...this.headerTableSelectionData,            },            // todo            // 列表信息            detail: [              ...(this.tableBodyData.map((item,index) => {                  item.rowno = index + 1;                  return item                }              ))            ]          }        }        if(!this.headerTableSelectionData.isinvoice) {          return this.$message({ type: 'warn', message: '请选择是否开票', duration: 1000 })        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.revenue, data, res => {          if (this.judgeValue(res)) {            this.$message({ type: 'success', message: '提交成功', duration: 1000 });            this.headerTableSelectionData = res.data[0]            // 修改状态为select            // 禁用表单            this.headerState = 'select'          }        })      },      // 审批      approvalHeader(row) {        this.$refs.approvalSelect.open(row)      },      confirmHeaderApprove(data) {        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.revenue, data, res => {          if (this.judgeValue(res)) {            // 返回列表状态            this.headerState = 'dealtSelect'            // 返回列表显示            this.isCardTab = false            // 刷新表头            this.dealtSelectHeader()            this.$refs.approvalSelect.close()          }        })      },      // 联查审批      jointApprovalHeader(row) {},      // 待办查询      dealtSelectHeader(row) {        this.headerState = 'dealtSelect'        // 返回列表显示        this.isCardTab = false        // 清空表体        this.tableBodyData = []        let data = {          action: 'workflow',          data: {            // checkman: ''          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.revenue, data, res => {          if (this.judgeValue(res)) {            this.$message({ type: 'success', message: '查询成功', duration: 1000 });            this.tableHeaderData = res.data || []          } else {            this.tableHeaderData = []          }        })      },      // 卡片列表显示      tabCard() {        this.isCardTab = !this.isCardTab      },      // 下载模板      download() {        // let url = 'http://192.168.100.121:9000/download/demoV1.3.xlsx';        let url = window.location.origin + '/download/demoV1.3.xlsx';        window.open(url)      },      // 导入      exportHeader(data) {        if (!data.length) {          return        }        let list = []        for (let i = 0, j = data.length; i < j; i++) {          let obj = {};          obj.custname = data[i]['客商']          obj.cust = ''          obj.jobname = data[i]['项目']          obj.job = ''          obj.amount = data[i]['金额'] || 0          obj.memo = data[i]['备注']          // if (!obj.should) { this.$message({ type: 'warn', message: '导入失败,请检查应发', duration: 1000 }); continue }          list.push(obj)        }        this.tableBodyData.push(...list)        if (list.length) {          this.$message({ type: 'success', message: '导入成功', duration: 1000 })        }      },      // 表体操作, 新增，编辑      tableBodyAdd(index, row) {        this.$refs.tableBodySelect.open('add', this.api, {})      },      tableBodyEdit(index, row) {        let data = this.$util.deepCopy(row)        this.$refs.tableBodySelect.open('edit', this.api, data, index)      },      confirmBodyOpera(type, data, i) {        switch (type) {          case 'add':              this.tableBodyData.push(data)            break          case 'edit':            let list = this.$util.deepCopy(this.tableBodyData)            list[i] = this.$util.deepCopy(data)            this.tableBodyData = list            break        }      },      // -- 删除      tableBodyDelete(index, row) {        // let isSk = this.tableBodyParam.active === 'sk'        // if (isSk) {          this.tableBodyData.splice(index, 1)        // } else {        //   this.tableBodyData.fy.splice(index, 1)        // }      },      // 表体合计: sk：收款人信息， fy：费用      getSummaries(param) {        const { columns, data } = param;        const sums = [];        columns.forEach((column, index) => {          if (index === 0) {            sums[index] = '合计';            return;          }          if (![2].includes(index)) {            return;          }          const values = data.map(item => Number(item[column.property]));          if (!values.every(value => isNaN(value))) {            sums[index] = values.reduce((prev, curr) => {              const value = Number(curr);              if (!isNaN(value)) {                return prev + curr;              } else {                return prev;              }            }, 0);            sums[index] = +(sums[index].toFixed(2))            sums[index] += ' 元';          } else {            sums[index] = '';          }          // 费用总计          if (index === 2) {            this.headerTableSelectionData.total = parseFloat(sums[2]) || ''          }        });        return sums;      },      // ===== 表格操作      // 表头项展开事件 - 表头 ： cbillid      expandRow(row, isExpand = true) {        this.$refs.headerTable.toggleRowExpansion(row, isExpand);      },      // 表头项选中事件      selectionRow(row, isSelect = true) {        this.$refs.headerTable.toggleRowSelection(row, isSelect);      },      // 表头项清空选中事件      clearSelection() {        this.$refs.headerTable.clearSelection();      },      // 获取row的key值      getRowKeys(row) {        return row[this.tableHeaderParam.rowKey];      },      // 表头选中事件 - 实现单选操作      headerSelectionChange(val) {        const self = this;        // 如果是新增态， 禁用操作 | 取消新增        if (this.headerState === 'add') {          return        }        if (val[1]) {          this.selectionRow(val[0], false);          this.selectionRow(val[1], true);          this.expandRow(val[0], false);          this.expandRow(val[1], true);        }        // this.headerState = 'select';        this.headerTableSelectionData = val[1] || val[0];        this.throttle(()=> {          self.getBodyData()        })      },      // ===== 数据请求      //请求表头内容      getHeaderData() {        // 表体清空        this.tableBodyData = []        let row = this.$util.deepCopy(this.headerSearchData)        row.data = JSON.stringify(row.data)        this.$ajax.postform(this.api.revenue, row, res => {          if (this.judgeValue(res)) {            this.tableHeaderData = res.data || []            this.$refs.querySelect.close()          }        })      },      //请求表体内容      getBodyData() {        let row = this.headerTableSelectionData || {}        if (!row[this.tableHeaderParam.rowKey]) {          this.tableBodyData = []          return        }        let data = {          action: 'querydetail',          data: {            cbillid: row.cbillid          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.revenue, data, res => {          if (this.judgeValue(res)) {            let result = res.data            this.tableBodyData = result          }        })      },      // 获取当前登录人      getUser(callback) {        let data = {          action: 'current',          data: {}        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            // deptname: "财务管理部"            // pk_deptdoc: "1004F810000000002V1R"            // pk_psndoc: "1004F8100000000034O3"            // psnname: "杨阿k"            if (!res.data[0].pk_deptdoc) {              this.headerState = 'select'              this.$message('无当前登录人部门信息')              return            }            this.headerTableSelectionData = {              ...this.headerTableSelectionData,              dept: res.data[0].pk_deptdoc,              deptname: res.data[0].deptname,              submitter: res.data[0].pk_psndoc,              submittername: res.data[0].psnname            }            if (callback) {              callback()            }          }        }, () => {          this.headerState = 'select'          this.$message('无当前登录人部门信息')        })      },      // 节流      throttle(fun, duration = 1000) {        if (this.timer)clearTimeout(this.timer)        this.timer = setTimeout(() => {          if (fun)fun()        }, duration)      },      // 文件解析      importExcel(e) {        const self = this;        let files = e.target.files;        let fileReader = new FileReader();        let data,workbook,persons = []        fileReader.onload = function(ev) {          try {            data = ev.target.result            workbook = XLSX.read(data, {              type: "binary"            }) // 以二进制流方式读取得到整份excel表格对象          } catch (e) {            console.log("文件类型不正确");            return;          }          // 表格的表格范围，可用于判断表头是否数量是否正确          let fromTo = "";          // 遍历每张表读取          for (let sheet in workbook.Sheets) {            if (workbook.Sheets.hasOwnProperty(sheet)) {              fromTo = workbook.Sheets[sheet]["!ref"];              persons = persons.concat(                XLSX.utils.sheet_to_json(workbook.Sheets[sheet])              );              // break; // 如果只取第一张表，就取消注释这行            }          }          self.exportHeader(persons)        };        // 以二进制方式打开文件        fileReader.readAsBinaryString(files[0]);      },      // 返回值判断      judgeValue(res, callback) {        if (res.success === 'Y') {          return true        } else {          this.$message({ type: 'warn', message: res.message, duration: 1000 })          return false        }      },      // 打印      print() {        const obj = this.headerTableSelectionData;        if (!obj.vbillno) {          return this.$message('当前打印数据为空')        }        sessionStorage['tableBodyData'] = JSON.stringify(this.tableBodyData)        sessionStorage['headerTableSelectionData'] = JSON.stringify(this.headerTableSelectionData)        let {href} = this.$router.resolve({          path: 'labourServices/printRevenue', query: {            // tableBodyData: JSON.stringify(this.tableBodyData),            // headerTableSelectionData: JSON.stringify(this.headerTableSelectionData),          }});        window.open(href, '_blank');      },      // 选择部门      handleDeptname() {        this.$refs.deptnameSelect.open(this.api.getData)      },      confirmDeptname(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          deptname: data.bxbmname,          dept: data.bxbm        }      },      // 选择提交人      handleSubmittername() {        this.$refs.submitternameSelect.open(this.api.getData)      },      confirmSubmittername(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          submittername: data.bxrname,          submitter: data.bxr        }      },      // 指派经办人      handleOperatorname() {        this.$refs.operatornameSelect.open(this.api.getData)      },      confirmOperatorname(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          operatorname: data.username,          operator: data.userid,        }        this.$refs.operatornameSelect.close()      },      // 指派财务      handleFinancename() {        this.$refs.financenameSelect.open(this.api.getData)      },      confirmFinancename(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          financename: data.username,          finance: data.userid,        }        this.$refs.financenameSelect.close()      },      // 关闭页面      goExit() {        if (navigator.userAgent.indexOf("MSIE") > 0) {          if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {            window.opener = null; window.close();          }          else {            window.open('', '_top'); window.top.close();          }        }        else if (navigator.userAgent.indexOf("Firefox") > 0) {          window.location.href = 'about:blank '; //火狐默认状态非window.open的页面window.close是无效的          //window.history.go(-2);        }        else {          window.opener = null;          window.open('', '_self', '');          window.close();        }      }    }  }</script><style scoped>  .fileInput{    position: absolute;    top: 0;    left: 0;    z-index: 100;    background: transparent;    color: transparent;  }  .table-header{    /*min-height: 200px;*/  }  .table-footer-seat{    height: 100px;  }  .table-footer{    min-height: 100px;  }  .table-footer{    position: fixed;    bottom: 0;    left: 0;    width: 100%;    z-index: 200;  }  .goExit{    position: absolute;    top: 40px;    right: 50px;    z-index: 100;  }</style>