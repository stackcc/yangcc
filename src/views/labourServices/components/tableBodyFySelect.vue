<template>  <div>  <!--查询-->  <el-dialog    title="费用明细"    width="70%"    :modal-append-to-body="false"    :append-to-body="false"    :visible.sync="param.visible"  >    <el-form :rules="rules" label-position="left" inline class="demo-table-expand c_h c_auto_y">      <template v-for="(item,i) in param.list">        <el-col :span="item.span || 12">          <template v-if="item.key === 'crtbank'">            <el-form-item :prop="item.key" :label="item.name">              <el-input size="small" style="width: 500px" :placeholder="item.tips" v-model="queryData[item.key]"></el-input>            </el-form-item>          </template>          <template v-else-if="item.type === 'textarea'">            <el-form-item :prop="item.key" :label="item.name">                <el-input                  style="width: 300px"                  type="textarea"                  :rows="3"                  :placeholder="item.tips"                  v-model="queryData[item.key]">                </el-input>            </el-form-item>          </template>          <template v-else-if="item.type === 'bank'">            <el-form-item :prop="item.key" :label="item.name">              <el-input                size="small"                :placeholder="item.tips"                v-model.number="queryData[item.key]"                @input="handleBankNum"              >              </el-input>            </el-form-item>          </template>          <template v-else-if="item.type === 'project'">            <el-form-item :prop="item.key" :label="item.name">              <el-input                size="small"                readonly                suffix-icon="el-icon-search"                :placeholder="item.tips"                v-model="queryData[item.key]"                v-on:click.native="handleTree"></el-input>            </el-form-item>          </template>          <template v-else-if="item.type === 'date'">            <el-form-item :prop="item.key" :label="item.name">              <el-date-picker                v-model="queryData[item.key]"                size="small"                :placeholder="item.tips"                value-format="yyyy-MM-dd">              </el-date-picker>            </el-form-item>          </template>          <template v-else-if="item.type === 'select'">            <el-form-item :prop="item.key" :label="item.name">              <el-select size="small" :placeholder="item.tips" v-model="queryData[item.key]" @change="selectChange(item)">                <el-option                  v-for="item in dataSource[item.dataList]"                  :key="item.value"                  :label="item.label"                  :value="item.value"                ></el-option>              </el-select>            </el-form-item>          </template>          <template v-else-if="item.type === 'number'">            <el-form-item :prop="item.key" :label="item.name">                <el-input size="small" type="number" :placeholder="item.tips" v-model="queryData[item.key]"></el-input>            </el-form-item>          </template>          <template v-else-if="item.type === 'test'">            <el-form-item class="c_opacity c_no_pointer" :prop="item.key" :label="item.name">              <el-input size="small" :placeholder="item.tips" v-model="queryData[item.key]"></el-input>            </el-form-item>          </template>          <template v-else>            <el-form-item :prop="item.key" :label="item.name">              <el-input size="small" :placeholder="item.tips" v-model="queryData[item.key]"></el-input>            </el-form-item>          </template>        </el-col>      </template>    </el-form>    <span slot="footer" class="dialog-footer">        <el-button size="small" @click="close">取 消</el-button>        <el-button type="primary" size="small" @click="confirmSelect">确 定</el-button>      </span>  </el-dialog>    <!--项目选择-->    <project-select ref="projectSelect" @confirm="confirmTree"></project-select>  </div></template><script>  import projectSelect from './project'  export default {    name: "tableBodySelect",    components: { projectSelect },    data() {      return {        api: '',        param: {          visible: false,          type: 'add',          index: 0,          list: [            { name: '出发日期', key: 'ccrq', type: "date", span: 8, tips: "请输入出发日期", required: true },            { name: '到达日期', key: 'def3', type: "date", span: 8, tips: "请输入到达日期", required: true },            { name: '出发地点', key: 'cfdd', type: "text", span: 8, tips: "请输入出发地点", required: true },            { name: '到达地点', key: 'dddd', type: "text", span: 8, tips: "请输入到达地点", required: true },            { name: '交通工具', key: 'jtgj', type: "select", dataList: "jtgjList", span: 8, tips: "请输入交通工具", required: true },            { name: '出差天数', key: 'ccts', type: "number", span: 8, tips: "请输入出差天数", required: true },            { name: '城市间交通费(元)', key: 'jtf', type: "number", span: 8, tips: "请输入交通费用-城市间交通费", required: true },            { name: '税率(%)', key: 'jtsl', type: "number", span: 8, tips: "请输入交通费用-税率", required: true },            { name: '税额(元)', key: 'jtse', type: "number", span: 8, tips: "请输入交通费用-税额", required: true },            { name: '住宿费(元)', key: 'zsf', type: "number", span: 8, tips: "请输入住宿费用-住宿费", required: true },            { name: '税率(%)', key: 'zssl', type: "number", span: 8, tips: "请输入住宿费用-税率", required: true },            { name: '税额(元)', key: 'zsse', type: "number", span: 8, tips: "请输入住宿费用-税额", required: true },            { name: '市内交通费(元)', key: 'snjtf', type: "number", span: 8, tips: "请输入补贴-市内交通费", required: true },            { name: '伙食补助(元)', key: 'hsbz', type: "number", span: 8, tips: "请输入补贴-伙食补助", required: true },            { name: '占位-12', key: 'test', type: "test", span: 8, tips: "占位" },            { name: '其他费用金额(元)', key: 'qtje', type: "number", span: 8, tips: "请输入其他费用-金额", required: true },            { name: '税率(%)', key: 'qtsl', type: "number", span: 8, tips: "请输入其他费用-税率", required: true },            { name: '税额(元)', key: 'qtse', type: "number", span: 8, tips: "请输入其他费用-税额", required: true },            { name: '报销金额(元)', key: 'bxje', type: "number", span: 12, tips: "请输入报销金额", required: true },            { name: '备注', key: 'fymemo', type: "textarea", span: 24, tips: "请输入备注", required: true }          ]        },        rules: {          idcard: [            { validator: this.validateIdcard, trigger: 'blur' }          ],        },        dataSource: {          idCardReg: /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/,          // 交通工具选项          jtgjList: [            // label : value            { label: '其他', value: '其他', sl: 0 },            { label: '城铁地铁', value: '城铁地铁', sl: 0 },            { label: '商务车', value: '商务车', sl: 0 },            { label: '公交车', value: '公交车', sl: 0 },            { label: '出租车', value: '出租车', sl: 0 },            { label: '长途汽车', value: '长途汽车', sl: 3 },            { label: '火车', value: '火车', sl: 9 },            { label: '飞机', value: '飞机', sl: 9 }          ],        },        queryData: {          ccrq: undefined,          def3: undefined,          cfdd: undefined,          dddd: undefined,          jtgj: undefined,          ccts: undefined,          jtf: undefined,          jtsl: undefined,          jtse: undefined,          zsf: undefined,          zssl: undefined,          zsse: undefined,          snjtf: undefined,          hsbz: undefined,          qtje: undefined,          qtsl: undefined,          qtse: undefined,          bxje: undefined,          fymemo: undefined        }      }    },    watch: {      // 城市交通费税额计算      "queryData.jtf"() {        this.getJtse()        this.getBxje()      },      "queryData.jtsl"() {        this.getJtse()      },      // 住宿费用税额计算      "queryData.zsf"() {        this.getZsse()        this.getBxje()      },      "queryData.zssl"() {        this.getZsse()      },      // 补贴      "queryData.ccts"() {        let ccts = +this.queryData.ccts || 0        let result_snjtf = (ccts * 80).toFixed(2)        let result_hsbz = (ccts * 100).toFixed(2)        // this.queryData.snjtf = +result_snjtf        // this.queryData.hsbz = +result_hsbz        this.$set(this.queryData, 'snjtf', +result_snjtf)        this.$set(this.queryData, 'hsbz', +result_hsbz)        this.getBxje()      },      // 市内交通费      "queryData.snjtf"() {        this.getBxje()      },      // 伙食补助      "queryData.hsbz"() {        this.getBxje()      },      // 其他费用税额计算      "queryData.qtje"() {        this.getQtse()        this.getBxje()      },      "queryData.qtsl"() {        this.getQtse()      }    },    methods: {      open(type, api, row, index) {        this.api = api        this.type = type        this.index = index        this.queryData = row || {}        if (this.queryData.banknum) {          this.queryData.banknum =  String(this.queryData.banknum).replace(/\s/g, '');        }        this.param.visible = true      },      close() {        this.queryData = {}        this.param.visible = false      },      confirmSelect() {        let obj = this.$util.deepCopy(this.queryData);        let result = this.verifyRule()        if (!result) {          return        }        this.$emit('confirm', this.type, obj, this.index)        this.close()      },      // 提交前校验      verifyRule() {        const list = this.param.list        const form = this.queryData        for (let i = 0; i < list.length; i++) {          if (list.required) {            if (!form[list[i].key]) {              this.$message({ message: list[i].tips, duration: 1000 })              return            }          }        }        return true      },      // 银行卡号展示格式      handleBankNum(value) {        let nospace = value.replace(/\s/g, '');        let result = nospace.replace(/(\d{4})/g, "$1 ").trim()        this.queryData.banknum = result      },      // rules      validateIdcard(rule, value, callback) {        value = this.queryData.idcard        const reg = this.dataSource.idCardReg        if (value === '') {          callback(new Error('请输入身份证'));        } else if(!reg.test(value)){          callback(new Error('请输入正确的身份证'));        } else {          callback();        }      },      // 表单中select类, change事件      selectChange(item) {        switch (item.key) {          case 'jtgj':  // 交通工具            let value = this.queryData.jtgj            let list = this.dataSource[item.dataList]            let arr = list.filter(o => o.label === value)            let sl = arr[0].sl            this.queryData = {              ...this.queryData,              jtsl: +sl            }            break        }      },      // 选择项目      handleTree() {        this.$refs.projectSelect.open(this.api)      },      //  项目 def4 提交      confirmTree(data) {        this.queryData = {          ...this.queryData,          def4name: data.jobname,          def4: data.pk_job        }      },      // 城市交通费税额计算      getJtse() {        let jtf = +this.queryData.jtf || 0        let jtsl = (+this.queryData.jtsl || 0 ) / 100        let result        // 火车,汽车:  城市交通费 / (1+税率) * 税率        // 飞机: (城市间交通费 - 50) / (1+税率) * 税率        if (this.queryData.jtgj === '火车' || this.queryData.jtgj === '长途汽车') {          result = (jtf / (1 + jtsl) * jtsl).toFixed(2)        } else if (this.queryData.jtgj === '飞机') {          result = ((jtf - 50) / (1 + jtsl) * jtsl).toFixed(2)        } else {          result = (jtf * jtsl).toFixed(2)        }        this.$set(this.queryData, 'jtse', +result)      },      // 住宿费税额计算      getZsse() {        // 金额 / (1+ 税率) * 税率        let zsf = +this.queryData.zsf || 0        let zssl = (+this.queryData.zssl || 0) / 100        let result = (zsf / (1 + zssl) * zssl).toFixed(2)        this.$set(this.queryData, 'zsse', +result)      },      // 其他费用税额计算      getQtse() {        // 金额 / (1+ 税率) * 税率        let qtje = +this.queryData.qtje || 0        let qtsl = (+this.queryData.qtsl || 0) / 100        let result = (qtje / (1 + qtsl) * qtsl).toFixed(2)        this.$set(this.queryData, 'qtse', +result)      },      // 报销金额计算      getBxje() {        // 城市间交通费+住宿费+市内交通费+伙食补助+其他费用        let jtf = +this.queryData.jtf || 0        let zsf = +this.queryData.zsf || 0        let snjtf = +this.queryData.snjtf || 0        let hsbz = +this.queryData.hsbz || 0        let qtje = +this.queryData.qtje || 0        let result = (jtf + zsf + snjtf + hsbz + qtje).toFixed(2)        this.$set(this.queryData, 'bxje', +result)      }    }  }</script><style scoped></style>