<template>  <el-main class="bg_white">    <el-button class="goExit" type="primary" size="small" round @click="goExit">关闭</el-button>    <el-card class="box-card">      <template v-for="(item, i) in funList">        <el-button class="c_rela" v-if="item.key === 'export'" :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">          {{ item.name }}          <input ref="fileInput" class="fileInput c_w c_h c_opacity" :class="!item.disabled && isExport ? '' : 'c_no_pointer'" type="file" @change="importExcel" />        </el-button>        <el-button v-else-if="item.key === 'card'" :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">          {{ isCardTab ? '列表显示' : '卡片显示' }}        </el-button>        <el-button v-else :key="i" type="primary" size="small" round :disabled="item.disabled" v-show="!item.isHide" @click="handleFun(item)">{{ item.name }}</el-button>      </template>    </el-card>    <div class="print-content">      <!--表头-->      <el-card>        <!--!!!!!!!待办============-->        <template v-if="headerState==='dealtSelect'">          <div v-show="isCardTab" class="">            <!--表头卡片-->            <el-form label-position="left" inline class="demo-table-expand">              <template v-for="(item,i) in tableHeaderParam.detailList_workflow">                <template v-if="item.key === 'vbillstatus'">                  <el-form-item :label="item.name">                    <el-select style="width: 100px" size="small" readonly :disabled="true" v-model="headerTableSelectionData[item.key]">                      <el-option                        v-for="item in dataSource.vbillstatusListMap"                        :key="item.value"                        :label="item.label"                        :value="item.value">                      </el-option>                    </el-select>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'deptname'">                  <el-form-item :label="item.name">                    <el-input style="width: 300px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'attachmentnum'">                  <el-form-item :label="item.name">                    <el-input style="width: 80px" size="small" :disabled="item.disabled || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'operator'">                  <el-form-item :label="item.name">                    <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'approver'">                  <el-form-item :label="item.name">                    <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'date'">                  <el-form-item :label="item.name">                    <el-date-picker                      style="width: 130px;"                      :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled"                      v-model="headerTableSelectionData[item.key]"                      size="small"                      type="date"                      placeholder="选择日期">                    </el-date-picker>                  </el-form-item>                </template>                <template v-else-if="item.type === 'project'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleTree"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'bxbmname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleBxbmname"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'bxrname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleBxrname"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'def1name'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDef1name"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'def3name'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDef3name"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'def4name'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDef4name"></el-input>                  </el-form-item>                </template>                <template v-else>                  <el-form-item :label="item.name">                    <el-input size="small" :disabled="item.disabled || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>              </template>            </el-form>          </div>          <div v-show="!isCardTab" class="table-header">            <!--表头列表-->            <el-table              ref="headerTable"              class="c_h"              :data="tableHeaderData"              :row-key="tableHeaderParam.rowKey"              :expand-row-keys="tableHeaderParam.expandRowKeys"              size="small"              height="300"              highlight-current-row              @selection-change="headerSelectionChange"            >              <el-table-column type="selection" width="55"></el-table-column>              <template v-for="(item, i) in tableHeaderParam.list_workflow">                <template v-if="item.key === 'vbillstatus'">                  <el-table-column :key="i" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ dataSource.vbillstatusList[scope.row[item.key]] }}                    </template>                  </el-table-column>                </template>                <template v-else>                  <el-table-column :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>                </template>              </template>            </el-table>          </div>        </template>        <!--!!!!!!!查询=============-->        <template v-else>          <div v-show="isCardTab" class="">            <!--表头卡片-->            <el-form label-position="left" inline class="demo-table-expand">              <template v-for="(item,i) in tableHeaderParam.detailList_query">                <template v-if="item.key === 'vbillstatus'">                  <el-form-item :label="item.name">                    <el-select style="width: 100px" size="small" readonly :disabled="true" v-model="headerTableSelectionData[item.key]">                      <el-option                        v-for="item in dataSource.vbillstatusListMap"                        :key="item.value"                        :label="item.label"                        :value="item.value">                      </el-option>                    </el-select>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'deptname'">                  <el-form-item :label="item.name">                    <el-input style="width: 300px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'attachmentnum'">                  <el-form-item :label="item.name">                    <el-input style="width: 80px" size="small" :disabled="item.disabled || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'operator'">                  <el-form-item :label="item.name">                    <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.key=== 'approver'">                  <el-form-item :label="item.name">                    <el-input style="width: 80px" size="small" :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'date'">                  <el-form-item :label="item.name">                    <el-date-picker                      style="width: 130px;"                      :disabled="item.disabled || (headerState === 'edit') || isHeaderDetailDisabled"                      v-model="headerTableSelectionData[item.key]"                      size="small"                      type="date"                      value-format="yyyy-MM-dd"                      placeholder="选择日期">                    </el-date-picker>                  </el-form-item>                </template>                <template v-else-if="item.type === 'project'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]" v-on:click.native="handleTree"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'def1name'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDef1name"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'def3name'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDef3name"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'def4name'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleDef4name"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'bxbmname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleBxbmname"></el-input>                  </el-form-item>                </template>                <template v-else-if="item.type === 'bxrname'">                  <el-form-item :label="item.name">                    <el-input                      size="small"                      readonly                      suffix-icon="el-icon-search"                      :disabled="item.disabled || isHeaderDetailDisabled"                      :class="(item.disabled || isHeaderDetailDisabled) ? 'c_no_pointer' : ''"                      v-model="headerTableSelectionData[item.key]"                      v-on:click.native="handleBxrname"></el-input>                  </el-form-item>                </template>                <template v-else>                  <el-form-item :label="item.name">                    <el-input size="small" :disabled="item.disabled || isHeaderDetailDisabled" v-model="headerTableSelectionData[item.key]"></el-input>                  </el-form-item>                </template>              </template>            </el-form>          </div>          <div v-show="!isCardTab" class="table-header c_h">            <!--表头列表-->            <el-table              ref="headerTable"              class="c_h"              :data="tableHeaderData"              :row-key="tableHeaderParam.rowKey"              :expand-row-keys="tableHeaderParam.expandRowKeys"              size="small"              height="250"              highlight-current-row              @selection-change="headerSelectionChange"            >              <el-table-column type="selection" width="55"></el-table-column>              <template v-for="(item, i) in tableHeaderParam.list_query">                <template v-if="item.key === 'vbillstatus'">                  <el-table-column :key="i" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ dataSource.vbillstatusList[scope.row[item.key]] }}                    </template>                  </el-table-column>                </template>                <template v-else>                  <el-table-column :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>                </template>              </template>            </el-table>          </div>        </template>      </el-card>      <!--表体-->      <el-card class="c_m_t_n" style="min-height: 200px;">          <el-tabs v-model="tableBodyParam.active" type="card">            <el-tab-pane label="收款人信息" name="sk">              <el-table                class="c_h"                size="small"                max-height="300"                show-summary                :summary-method="getSummaries_sk"                :data="tableBodyData.sk"              >                <template v-if="headerState==='add' || headerState==='edit'" slot="empty">                  <el-button                    v-show="['add', 'edit'].includes(headerState)"                    size="mini"                    type="primary"                    @click="tableBodyAdd">新增</el-button>                </template>                <template v-for="(item, i) in tableBodyParam.list_sk">                  <el-table-column v-if="item.key === 'rowno'" :key="i" :width="item.width" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ scope.$index + 1}}                    </template>                  </el-table-column>                  <el-table-column v-else :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>                </template>                <el-table-column :fixed="['add', 'edit'].includes(headerState)? 'right': false" width="220" label="操作">                  <template slot-scope="scope">                    <!--v-show="['add', 'edit'].includes(headerState) && (scope.$index+1 === tableBodyData.length)"-->                    <el-button                      v-show="['add', 'edit'].includes(headerState)"                      size="mini"                      type="primary"                      @click="tableBodyAdd(scope.$index, scope.row)">新增</el-button>                    <el-button                      v-show="['add', 'edit'].includes(headerState)"                      size="mini"                      type="primary"                      @click="tableBodyEdit(scope.$index, scope.row)">编辑</el-button>                    <el-button                      v-show="['add', 'edit'].includes(headerState)"                      size="mini"                      type="danger"                      @click="tableBodyDelete(scope.$index, scope.row)">删除</el-button>                  </template>                </el-table-column>              </el-table>            </el-tab-pane>            <el-tab-pane label="费用明细" name="fy">              <el-table                class="c_h"                size="small"                max-height="300"                show-summary                :summary-method="getSummaries_fy"                :data="tableBodyData.fy"              >                <template v-if="headerState==='add' || headerState==='edit'" slot="empty">                  <el-button                    v-show="['add', 'edit'].includes(headerState)"                    size="mini"                    type="primary"                    @click="tableBodyAdd">新增</el-button>                </template>                <template v-for="(item, i) in tableBodyParam.list_fy">                  <el-table-column v-if="item.key === 'rowno'" :key="i" :width="item.width" :label="item.name" :prop="item.key">                    <template slot-scope="scope">                      {{ scope.$index + 1}}                    </template>                  </el-table-column>                  <template v-else-if="item.isTitle">                      <el-table-column :label="item.name" align="center">                        <template v-for="(subItem, sub) in item.children">                          <el-table-column :key="i + '-' + sub" :width="subItem.width" :label="subItem.name" :prop="subItem.key"></el-table-column>                        </template>                      </el-table-column>                  </template>                  <el-table-column v-else :key="i" :width="item.width" :label="item.name" :prop="item.key"></el-table-column>                </template>                <el-table-column :fixed="['add', 'edit'].includes(headerState)? 'right': false" width="220" label="操作">                  <template slot-scope="scope">                    <!--v-show="['add', 'edit'].includes(headerState) && (scope.$index+1 === tableBodyData.length)"-->                    <el-button                      v-show="['add', 'edit'].includes(headerState)"                      size="mini"                      type="primary"                      @click="tableBodyAdd(scope.$index, scope.row)">新增</el-button>                    <el-button                      v-show="['add', 'edit'].includes(headerState)"                      size="mini"                      type="primary"                      @click="tableBodyEdit(scope.$index, scope.row)">编辑</el-button>                    <el-button                      v-show="['add', 'edit'].includes(headerState)"                      size="mini"                      type="danger"                      @click="tableBodyDelete(scope.$index, scope.row)">删除</el-button>                  </template>                </el-table-column>              </el-table>            </el-tab-pane>          </el-tabs>      </el-card>    </div>    <!-- 查询条件弹框 -->    <query-select ref="querySelect" @confirm="confirmHeaderQuery"></query-select>    <!-- 审批条件弹框 -->    <approval-select ref="approvalSelect" @confirm="confirmHeaderApprove"></approval-select>    <!--项目选择-->    <project-select ref="projectSelect" @confirm="confirmTree"></project-select>    <!--费用承担部门 -->    <def1name-select ref="def1nameSelect" @confirm="confirmDef1name"></def1name-select>    <!--报销部门 -->    <bxbmname-select ref="bxbmnameSelect" @confirm="confirmBxbmname"></bxbmname-select>    <!--报销人-->    <bxrname-select ref="bxrnameSelect" @confirm="confirmBxrname"></bxrname-select>    <!-- 表体新增，编辑弹框: 收款人信息 -->    <table-body-sk-select ref="tableBodySkSelect" @confirm="confirmBodySkOpera"></table-body-sk-select>    <!-- 表体新增，编辑弹框： 费用明细 -->    <table-body-fy-select ref="tableBodyFySelect" @confirm="confirmBodyFyOpera"></table-body-fy-select>    <!--指派经办人 -->    <def3name-select ref="def3nameSelect" rolecode="CW02" title="指派经办人" @confirm="confirmDef3name"></def3name-select>    <!--指派财务 -->    <def4name-select ref="def4nameSelect" title="指派财务" @confirm="confirmDef4name"></def4name-select>  </el-main></template><script>  import querySelect from './components/select'  import approvalSelect from './components/approval'  import projectSelect from './components/project'  import bxbmnameSelect from './components/bxbmSelect'  import bxrnameSelect from './components/bxrSelect'  import def1nameSelect from './components/bxbmSelect'  import tableBodySkSelect from './components/tableBodySkSelect'  import tableBodyFySelect from './components/tableBodyFySelect'  import def3nameSelect from './components/def1name'  import def4nameSelect from './components/def1name'  export default {    name: "travelExpenses",    components: {      querySelect,      approvalSelect,      projectSelect,      bxbmnameSelect,      bxrnameSelect,      def1nameSelect,      tableBodySkSelect,      tableBodyFySelect,      def3nameSelect,      def4nameSelect    },    mixins: [],    data() {      return {        timer: undefined,        isCardTab: false,        // 功能菜单        // -- [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        funList: [          { name: '查询', type: 'primary', disabled: false, isHide: false, key: 'select', handle: 'selectHeader' },          { name: '修改', type: 'primary', disabled: false, isHide: false, key: 'edit', handle: 'editHeader' },          { name: '增加', type: 'primary', disabled: false, isHide: false, key: 'add', handle: 'addHeader' },          { name: '删除', type: 'primary', disabled: false, isHide: false, key: 'del', handle: 'delHeader' },          { name: '取消', type: 'primary', disabled: false, isHide: false, key: 'cancel', handle: 'cancelHeader' },          { name: '提交', type: 'primary', disabled: false, isHide: false, key: 'confirm', handle: 'confirmHeader' },          { name: '审批', type: 'primary', disabled: false, isHide: false, key: 'approval', handle: 'approvalHeader' },          // { name: '联查审批情况', type: 'primary', disabled: false, isHide: false, key: 'joinApproval', handle: 'jointApprovalHeader' },          { name: '待办查询', type: 'primary', disabled: false, isHide: false, key: 'dealtSelect', handle: 'dealtSelectHeader' },          // { name: '导入', type: 'primary', disabled: false, isHide: false, key: 'export', handle: 'exportHeader' },          { name: '列表显示', type: 'primary', disabled: false, isHide: false, key: 'card', handle: 'tabCard' },          // { name: '下载模板', type: 'primary', disabled: false, isHide: false, key: 'download', handle: 'download' },          // { name: '导出', type: 'primary', disabled: false, isHide: false, key: 'exportExccel', handle: 'exportExccel' },          { name: '打印', type: 'primary', disabled: false, isHide: false, key: 'print', handle: 'print' },        ],        // api        api: {          // todo --- 接口          // 劳务+差旅 公共接口          // getData: '/api/service/GlLaborwage?userid=0001F8100000000000S1',          getData: '/service/GlLaborwage?userid=' + this.$route.query.userid,          // 差旅 接口          // travelExpense: '/api/service/GlTravelbx?userid=0001F8100000000000S1',          travelExpense: '/service/GlTravelbx?userid=' + this.$route.query.userid,        },        dataSource: {          vbillstatusListMap: [            { value: 0, label: '审批不通过' },            { value: 1, label: '审核通过' },            { value: 2, label: '审批进行中' },            { value: 3, label: '提交' },            { value: 8,  label: '自由' }          ],          vbillstatusList: {            0: '审批不通过',            1: '审核通过',            2: '审批进行中',            3: '提交',            8:  '自由'          },        },        // 表头参数        // -- 表头状态        headerState: 'select',        // -- 请求参数        //  --query:单据查询        //  --add:新增单据        //  --workflow:待办查询        //  --approve:审批单据        headerSearchData: {          action: 'query',          data: {}        },        // -- 表格参数        tableHeaderParam: {          list: [],          list_query: [            { name: '单据编号', key: 'vbillno', width: 120, isUse: true },            { name: '单据日期', key: 'dbilldate', isUse: true },            { name: '摘要', key: 'zy', isUse: true },            { name: '合同（协议）编号', key: 'ht', isUse: true },            { name: '项目', key: 'xmname', isUse: true },            { name: '指派经办人', key: 'def3name', isUse: true },            { name: '指派财务', key: 'def4name', isUse: true },            { name: '费用承担部门', key: 'def1name', width: 220, isUse: true },            { name: '报销部门', key: 'bxbmname', width: 220, isUse: true },            { name: '报销人', key: 'bxrname', isUse: true },            { name: '附件张数', key: 'fjzs', isUse: true },            { name: '事由', key: 'sy', isUse: true },          ],          list_workflow: [            { name: '单据编号', key: 'vbillno', width: 120, isUse: true },            { name: '单据日期', key: 'dbilldate', isUse: true },            { name: '摘要', key: 'zy', isUse: true },            { name: '合同（协议）编号', key: 'ht', isUse: true },            { name: '项目', key: 'xmname', isUse: true },            { name: '指派经办人', key: 'def3name', width: 220, isUse: true },            { name: '指派财务', key: 'def4name', width: 220, isUse: true },            { name: '费用承担部门', key: 'def1name', width: 220, isUse: true },            { name: '报销部门', key: 'bxbmname', width: 220, isUse: true },            { name: '报销人', key: 'bxrname', isUse: true },            { name: '附件张数', key: 'fjzs', isUse: true },            { name: '事由', key: 'sy', isUse: true },            { name: '发送人', key: 'sendman', isUse: true },            { name: '发送时间', key: 'senddate', width: 150, isUse: true },          ],          detailList: [],          detailList_query: [            { name: '单据号', key: 'vbillno', width: 120, disabled: true, isUse: false },            { name: '单据日期', key: 'dbilldate', type: 'date', disabled: false, isUse: true },            { name: '摘要', key: 'zy', disabled: false, isUse: true },            { name: '合同（协议）编号', key: 'ht', disabled: false, isUse: true },            { name: '项目', key: 'xmname', type: 'project', disabled: false, isUse: true },            { name: '指派经办人', key: 'def3name', type: 'def3name', disabled: false, isUse: true },            { name: '指派财务', key: 'def4name', type: 'def4name', disabled: false, isUse: true },            { name: '费用承担部门', key: 'def1name', type: 'def1name', disabled: false, isUse: true },            { name: '报销部门', key: 'bxbmname', type: 'bxbmname', disabled: false, isUse: true },            { name: '报销人', key: 'bxrname', type: 'bxrname', disabled: false, isUse: true },            { name: '附件张数', key: 'fjzs', disabled: false, isUse: true },            { name: '事由', key: 'sy', disabled: false, isUse: true }          ],          detailList_workflow: [            { name: '单据号', key: 'vbillno', width: 120, disabled: true, isUse: false },            { name: '单据日期', key: 'dbilldate', type: 'date', disabled: true, isUse: true },            { name: '摘要', key: 'zy', disabled: false, isUse: true },            { name: '合同（协议）编号', key: 'ht', disabled: false, isUse: true },            { name: '项目', key: 'xmname', type: 'project', disabled: true, isUse: true },            { name: '指派经办人', key: 'def3name', type: 'def3name', disabled: true, isUse: true },            { name: '指派财务', key: 'def4name', type: 'def4name', disabled: true, isUse: true },            { name: '费用承担部门', key: 'def1name', type: 'def1name', disabled: true, isUse: true },            { name: '报销部门', key: 'bxbmname', type: 'bxbmname', disabled: true, isUse: true },            { name: '报销人', key: 'bxrname', type: 'bxrname', disabled: true, isUse: true },            { name: '附件张数', key: 'fjzs', disabled: false, isUse: true },            { name: '事由', key: 'sy', disabled: false, isUse: true },          ],          rowKey: 'cbillid',          expandRowKeys: []        },        // -- 表格列表数据        tableHeaderData: [],        // -- 当前被选中表头项 | 表体请求参数        headerTableSelectionData: {},        // 表体参数        // -- 表格参数        tableBodyParam: {          // 表体页签          active: 'sk', // sk, fy          list: [],          // 收款人信息: sk          list_sk: [            { name: '收款人', key: 'skrname', isUse: true },            { name: '部门', key: 'bmname', isUse: true },            { name: '收款人银行账号', key: 'yhzhname', isUse: true },            { name: '金额(元)', key: 'je', isUse: true },            // { name: '收款客商', key: 'def1', isUse: true },            // { name: '客商银行账户', key: 'def2', isUse: true },            { name: '备注', key: 'skbz', isUse: true }          ],          // 费用明细: fy          list_fy: [            { name: '出差日期', key: 'ccrq', width: 100, isUse: true },            { name: '出发地点', key: 'cfdd', isUse: true },            { name: '到达地点', key: 'dddd', isUse: true },            { name: '交通工具', key: 'jtgj', isUse: true },            { name: '出差天数', key: 'ccts', isUse: true },            { name: '交通费用', isTitle: true, children: [                { name: '城市间交通费(元)', key: 'jtf', width: 100, isUse: true },                { name: '税率(%)', key: 'jtsl', isUse: true },                { name: '税额(元)', key: 'jtse', width: 100, isUse: true }              ]            },            { name: '住宿费用', isTitle: true, children: [                { name: '住宿费(元)', key: 'zsf', width: 100, isUse: true },                { name: '税率(%)', key: 'zssl', isUse: true },                { name: '税额(元)', key: 'zsse', width: 100, isUse: true }              ]            },            { name: '补贴', isTitle: true, children: [                { name: '市内交通费(元)', key: 'snjtf', width: 100, isUse: true },                { name: '伙食补助(元)', key: 'hsbz', isUse: true }              ]            },            { name: '其他费用', isTitle: true, children: [                { name: '金额(元)', key: 'qtje', width: 100, isUse: true },                { name: '税率(%)', key: 'qtsl', isUse: true },                { name: '税额(元)', key: 'qtse', width: 100, isUse: true },              ]            },            { name: '报销金额(元)', key: 'bxje', width: 100, isUse: true },            { name: '备注', key: 'fymemo', isUse: true }          ]        },        // -- 表格列表数据        tableBodyData: {          // 收款人信息          sk: [],          // 费用明细          fy: []        },        // 表尾参数        // -- 表单参数        footerParam: {          form: [            // { name: '经办人', key: 'operator', isUse: true },            // { name: '最终修改人', key: 'clastmodifier', isUse: true },            // { name: '审核人', key: 'approver', isUse: true },            // { name: '单据状态', key: 'vbillstatus', isUse: true },          ]        },        // -- 表单数据        footerData: {          voperatorid: '录入人',          clastmodifier: '最终修改人',          vapproveid: '审核人',          vbillstatus: '单据状态',        },      }    },    computed: {      // 是否可以编辑详情卡片      isHeaderDetailDisabled(props) {        // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        return !['edit', 'add'].includes(this.headerState)      },      // 是否可以使用导入功能      isExport() {        // 未禁用        // 有唯一key值        // 属于编辑态和新增态        return (['edit', 'add'].includes(this.headerState))      }    },    watch: {      headerState(val) {        switch (val) {          case 'select':            this.setFunAuth([ 'select', 'edit', 'add', 'del', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])            break;          case 'edit':            this.setFunAuth([ 'cancel', 'confirm', 'export'])            break;          case 'add':            this.setFunAuth([ 'cancel', 'confirm', 'export', 'download', 'exportExccel', 'print'])            break;          case 'joinApproval':            this.setFunAuth([ 'select', 'edit', 'add', 'del', 'approval', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])            break;          case 'dealtSelect':            this.setFunAuth([ 'select', 'edit', 'add', 'cancel', 'approval', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])            break;        }      }    },    mounted() {      this.setFunAuth([ 'select', 'edit', 'add', 'del', 'joinApproval', 'dealtSelect', 'card', 'download', 'exportExccel', 'print'])      // this.headerState = 'select'      // this.selectHeader()    },    methods: {      // 功能菜单事件      handleFun(item) {        let row = this.headerTableSelectionData;        switch (item.key) {          case 'select':            this.headerState = item.key;            this[item.handle](row);            break;          case 'edit':            if (!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this.headerState = item.key;            this[item.handle](row);            break;          case 'add':            this.headerState = item.key;            this[item.handle](row);            break;          case 'cancel':            this[item.handle](row);            break;          case 'confirm':            this[item.handle](row);            break;          // case 'del':          //   this[item.handle](row);          //   break;          // case 'approval': // 审批          //   this[item.handle](row);          //   break;          // case 'joinApproval': // 联查审批情况          //   this[item.handle](row);          //   break;          case 'export':            if (this.headerState === 'add') {              this[item.handle](row);              return;            } else if(!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this[item.handle](row);            break;          case 'dealtSelect':            this.headerState = item.key;            this[item.handle](row);            break;          // case 'card':          //   this[item.handle](row);          //   break;          case 'download':            this[item.handle](row);            break;          case 'print':            this[item.handle](row);            break;          case 'exportExccel':            this[item.handle](row);            break;          default:            if (!row || !row[this.tableHeaderParam.rowKey]) {              return this.$message({ type: 'warn', message: '请选择需要操作的单据', duration: 1000 });            }            this[item.handle](row);        }      },      // 功能菜单权限控制      setFunAuth(list = [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export', 'card']) {        // [ 'select', 'edit', 'add', 'del', 'cancel', 'confirm', 'approval', 'joinApproval', 'dealtSelect', 'export']        this.funList = this.funList.map(item => {          item.disabled = !list.includes(item.key)          return item        })      },      // 查询      selectHeader(row) {        this.$refs.querySelect.open(row)      },      confirmHeaderQuery(data) {        // 返回列表显示        this.isCardTab = false        // 清空表体        this.tableBodyData = { sk: [], fy: [] }        // 查询条件        this.headerSearchData = data        this.getHeaderData()      },      // 修改      editHeader(row) {        // 禁用其他操作        this.setFunAuth(['cancel', 'confirm', 'export'])        // 切换到卡片新增        this.isCardTab = true      },      // 增加      addHeader(row) {        // 取消其他选中        this.clearSelection();        // 清空表头选中数据,设置默认值        this.headerTableSelectionData = {          zy: "代发差旅费",          dbilldate: this.$tool.formatDate('', 1)        }        // 获取当前登陆人        this.getUser(() => {          // 清空表体          this.tableBodyData = { sk: [], fy: [] }          // 禁用其他操作          this.setFunAuth(['cancel', 'confirm', 'export'])          // 切换到卡片新增          this.isCardTab = true        })      },      // 删除      delHeader(row) {        const self = this        this.$confirm('确定要删除吗?', '删除提示', {          confirmButtonText: '确定',          cancelButtonText: '取消',          type: 'warning'        }).then(() => {          let data = {            action: 'del',            data: {              cbillid: row.cbillid            }          }          data.data = JSON.stringify(data.data)          this.$ajax.postform(this.api.travelExpense, data, res => {            if (self.judgeValue(res)) {              self.$message({                type: 'success',                message: '删除成功!',                duration: 1000              });              // 返回列表状态              this.headerState = 'select'              // 返回列表显示              this.isCardTab = false              // 刷新表头              self.getHeaderData()            }          })        });      },      // 取消      cancelHeader(row) {        // 取消权限控制        this.setFunAuth()        if (this.headerState === 'add') {          // 清空表体          this.tableHeaderData = []          this.tableBodyData = { sk: [], fy: [] }          // 刷新表头          this.getHeaderData()        }        // 返回列表状态        this.headerState = 'select'        // 返回列表显示        this.isCardTab = false      },      // 提交      confirmHeader(row) {        if (!['edit', 'add'].includes(this.headerState)){          return this.$message({ type: 'warn', message: '没有需要提交的内容', duration: 1000 });        }        if (this.headerTableSelectionData.totalSk !== this.headerTableSelectionData.totalFy) {          return this.$message({ type: 'warn', message: '费用明细金额与收款人金额总计不同,请仔细核对!', duration: 1000 });        }        let data = {          action: 'add',          data: {            head: {              ...this.headerTableSelectionData,            },            // 收款人信息            settlementinfo: [              ...(this.tableBodyData.sk.map((item,index) => {                  item.rowno = index + 1;                  return item                }              ))            ],            // 费用明细            expensesinfo: [              ...(this.tableBodyData.fy.map((item,index) => {                  item.rowno = index + 1;                  return item                }              ))            ]          }        }        // if(!data.data.attachmentnum) {        //   return this.$message({ type: 'warn', message: '请填写附件张数', duration: 1000 })        // }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.travelExpense, data, res => {          if (this.judgeValue(res)) {            this.$message({ type: 'success', message: '提交成功', duration: 1000 });            this.headerTableSelectionData = res.data[0]            // 修改状态为select            // 禁用表单            this.headerState = 'select'          }        })      },      // 审批      approvalHeader(row) {        this.$refs.approvalSelect.open(row)      },      confirmHeaderApprove(data) {        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.travelExpense, data, res => {          if (this.judgeValue(res)) {            // 返回列表状态            this.headerState = 'dealtSelect'            // 返回列表显示            this.isCardTab = false            // 刷新表头            this.dealtSelectHeader()            this.$refs.approvalSelect.close()          }        })      },      // 联查审批      jointApprovalHeader(row) {},      // 待办查询      dealtSelectHeader(row) {        this.headerState = 'dealtSelect'        // 返回列表显示        this.isCardTab = false        // 清空表体        this.tableBodyData = { sk: [], fy: [] }        let data = {          action: 'workflow',          data: {            // checkman: ''          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.travelExpense, data, res => {          if (this.judgeValue(res)) {            this.$message({ type: 'success', message: '查询成功', duration: 1000 });            this.tableHeaderData = res.data || []          } else {            this.tableHeaderData = []          }        })      },      // 卡片列表显示      tabCard() {        this.isCardTab = !this.isCardTab      },      // 下载模板      download() {        // let url = 'http://192.168.100.121:9000/download/demoV1.3.xlsx';        let url = window.location.origin + '/download/demoV1.3.xlsx';        window.open(url)      },      // 表体操作, 新增，编辑      tableBodyAdd(index, row) {        let isSk = this.tableBodyParam.active === 'sk'        let data = {}        if (isSk) {          data.bm = this.headerTableSelectionData.bm          this.$refs.tableBodySkSelect.open('add', this.api.getData, data)        } else {          this.$refs.tableBodyFySelect.open('add', this.api.getData, data)        }      },      tableBodyEdit(index, row) {        let data = this.$util.deepCopy(row)        let isSk = this.tableBodyParam.active === 'sk'        if (isSk) {          this.$refs.tableBodySkSelect.open('edit', this.api.getData, data, index)        } else {          this.$refs.tableBodyFySelect.open('edit', this.api.getData, data, index)        }      },      confirmBodySkOpera(type, data, i) {        switch (type) {          case 'add':              this.tableBodyData.sk.push(data)            break          case 'edit':            let list = this.$util.deepCopy(this.tableBodyData.sk)            list[i] = this.$util.deepCopy(data)            this.tableBodyData.sk = list            break        }      },      confirmBodyFyOpera(type, data, i) {        switch (type) {          case 'add':              this.tableBodyData.fy.push(data)            break          case 'edit':            let list = this.$util.deepCopy(this.tableBodyData.fy)            list[i] = this.$util.deepCopy(data)            this.tableBodyData.fy = list            break        }      },      // -- 删除      tableBodyDelete(index, row) {        let isSk = this.tableBodyParam.active === 'sk'        if (isSk) {          this.tableBodyData.sk.splice(index, 1)        } else {          this.tableBodyData.fy.splice(index, 1)        }      },      // 表体合计: sk：收款人信息， fy：费用      getSummaries_sk(param) {        const { columns, data } = param;        const sums = [];        columns.forEach((column, index) => {          if (index === 0) {            sums[index] = '合计';            return;          }          if (![3].includes(index)) {            return;          }          const values = data.map(item => Number(item[column.property]));          if (!values.every(value => isNaN(value))) {            sums[index] = values.reduce((prev, curr) => {              const value = Number(curr);              if (!isNaN(value)) {                return prev + curr;              } else {                return prev;              }            }, 0);            sums[index] = +(sums[index].toFixed(2))            sums[index] += ' 元';          } else {            sums[index] = '';          }          // 费用总计          if (index === 3) {            this.headerTableSelectionData.totalSk = parseFloat(sums[3]) || ''          }        });        return sums;      },      getSummaries_fy(param) {        const { columns, data } = param;        const sums = [];        columns.forEach((column, index) => {          if (index === 0) {            sums[index] = '合计';            return;          }          if (![5, 7, 8, 10, 11, 12, 13, 15, 16, 17].includes(index)) {            return;          }          const values = data.map(item => Number(item[column.property]));          if (!values.every(value => isNaN(value))) {            sums[index] = values.reduce((prev, curr) => {              const value = Number(curr);              if (!isNaN(value)) {                return prev + curr;              } else {                return prev;              }            }, 0);            sums[index] = +(sums[index].toFixed(4))            sums[index] += ' 元';          } else {            sums[index] = '';          }          // 费用总计          if (index === 16) {            this.headerTableSelectionData.totalFy = parseFloat(sums[16]) || ''          }        });        return sums;      },      // ===== 表格操作      // 表头项展开事件 - 表头 ： cbillid      expandRow(row, isExpand = true) {        this.$refs.headerTable.toggleRowExpansion(row, isExpand);      },      // 表头项选中事件      selectionRow(row, isSelect = true) {        this.$refs.headerTable.toggleRowSelection(row, isSelect);      },      // 表头项清空选中事件      clearSelection() {        this.$refs.headerTable.clearSelection();      },      // 获取row的key值      getRowKeys(row) {        return row[this.tableHeaderParam.rowKey];      },      // 表头选中事件 - 实现单选操作      headerSelectionChange(val) {        const self = this;        // 如果是新增态， 禁用操作 | 取消新增        if (this.headerState === 'add') {          return        }        if (val[1]) {          this.selectionRow(val[0], false);          this.selectionRow(val[1], true);          this.expandRow(val[0], false);          this.expandRow(val[1], true);        }        // this.headerState = 'select';        this.headerTableSelectionData = val[1] || val[0];        this.throttle(()=> {          self.getBodyData()        })      },      // ===== 数据请求      //请求表头内容      getHeaderData() {        // 表体清空        this.tableBodyData = { sk: [], fy: [] }        let row = this.$util.deepCopy(this.headerSearchData)        row.data = JSON.stringify(row.data)        this.$ajax.postform(this.api.travelExpense, row, res => {          if (this.judgeValue(res)) {            this.tableHeaderData = res.data || []            this.$refs.querySelect.close()          }        })      },      //请求表体内容      getBodyData() {        let row = this.headerTableSelectionData || {}        if (!row[this.tableHeaderParam.rowKey]) {          this.tableBodyData = { sk: [], fy: [] }          return        }        let data = {          action: 'querydetail',          data: {            cbillid: row.cbillid          }        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.travelExpense, data, res => {          if (this.judgeValue(res)) {            let result = res.data            this.tableBodyData = {              sk: result.settlementinfo,              fy: result.expensesinfo,            }            // { sk: [], fy: [] }          }        })      },      // 获取当前登录人      getUser(callback) {        let data = {          action: 'current',          data: {}        }        data.data = JSON.stringify(data.data)        this.$ajax.postform(this.api.getData, data, res => {          if (this.judgeValue(res)) {            // deptname: "财务管理部"            // pk_deptdoc: "1004F810000000002V1R"            // pk_psndoc: "1004F8100000000034O3"            // psnname: "杨阿k"            if (!res.data[0].pk_deptdoc) {              this.headerState = 'select'              this.$message('无当前登录人部门信息')              return            }            this.headerTableSelectionData = {              ...this.headerTableSelectionData,              def1: res.data[0].pk_deptdoc,              def1name: res.data[0].deptname,              bxbm: res.data[0].pk_deptdoc,              bxbmname: res.data[0].deptname,              bxr: res.data[0].pk_psndoc,              bxrname: res.data[0].psnname            }            if (callback) {              callback()            }          }        }, () => {          this.headerState = 'select'          this.$message('无当前登录人部门信息')        })      },      // 节流      throttle(fun, duration = 1000) {        if (this.timer)clearTimeout(this.timer)        this.timer = setTimeout(() => {          if (fun)fun()        }, duration)      },      // 文件解析      importExcel(e) {        const self = this;        let files = e.target.files;        let fileReader = new FileReader();        let data,workbook,persons = []        fileReader.onload = function(ev) {          try {            data = ev.target.result            workbook = XLSX.read(data, {              type: "binary"            }) // 以二进制流方式读取得到整份excel表格对象          } catch (e) {            console.log("文件类型不正确");            return;          }          // 表格的表格范围，可用于判断表头是否数量是否正确          let fromTo = "";          // 遍历每张表读取          for (let sheet in workbook.Sheets) {            if (workbook.Sheets.hasOwnProperty(sheet)) {              fromTo = workbook.Sheets[sheet]["!ref"];              persons = persons.concat(                XLSX.utils.sheet_to_json(workbook.Sheets[sheet])              );              // break; // 如果只取第一张表，就取消注释这行            }          }          self.exportHeader(persons)        };        // 以二进制方式打开文件        fileReader.readAsBinaryString(files[0]);      },      // 返回值判断      judgeValue(res, callback) {        if (res.success === 'Y') {          return true        } else {          this.$message({ type: 'warn', message: res.message, duration: 1000 })          return false        }      },      // 选择项目      handleTree() {        this.$refs.projectSelect.open(this.api.getData)      },      //  项目 提交      confirmTree(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          xmname: data.jobname,          xm: data.pk_job          // projectname: data.jobname,          // pk_job: data.pk_job        }      },      // 选择费用承担部门      handleDef1name() {        this.$refs.def1nameSelect.open(this.api.getData)      },      // 提交费用承担部门      confirmDef1name(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          def1name: data.bxbmname,          def1: data.bxbm        }      },      // 选择报销部门      handleBxbmname() {        this.$refs.bxbmnameSelect.open(this.api.getData)      },      // 提交报销部门      confirmBxbmname(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          bxbmname: data.bxbmname,          bxbm: data.bxbm        }      },      // 选择报销人      handleBxrname() {        this.$refs.bxrnameSelect.open(this.api.getData)      },      // 提交报销人      confirmBxrname(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          bxrname: data.bxrname,          bxr: data.bxr        }      },      // 打印      print() {        const obj = this.headerTableSelectionData;        if (!obj.vbillno) {          return this.$message('当前打印数据为空')        }        sessionStorage['tableBodyData'] = JSON.stringify(this.tableBodyData)        sessionStorage['headerTableSelectionData'] = JSON.stringify(this.headerTableSelectionData)        let {href} = this.$router.resolve({          path: 'labourServices/printTravelExpenses', query: {            // tableBodyData: JSON.stringify(this.tableBodyData),            // headerTableSelectionData: JSON.stringify(this.headerTableSelectionData),          }});        window.open(href, '_blank');      },      // 指派经办人      handleDef3name() {        this.$refs.def3nameSelect.open(this.api.getData)      },      confirmDef3name(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          def3name: data.username,          def3: data.userid,        }        this.$refs.def3nameSelect.close()      },      // 指派财务      handleDef4name() {        this.$refs.def4nameSelect.open(this.api.getData)      },      confirmDef4name(data) {        this.headerTableSelectionData = {          ...this.headerTableSelectionData,          def4name: data.username,          def4: data.userid,        }        this.$refs.def4nameSelect.close()      },      // 关闭页面      goExit() {        if (navigator.userAgent.indexOf("MSIE") > 0) {          if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {            window.opener = null; window.close();          }          else {            window.open('', '_top'); window.top.close();          }        }        else if (navigator.userAgent.indexOf("Firefox") > 0) {          window.location.href = 'about:blank '; //火狐默认状态非window.open的页面window.close是无效的          //window.history.go(-2);        }        else {          window.opener = null;          window.open('', '_self', '');          window.close();        }      }    }  }</script><style scoped>  .fileInput{    position: absolute;    top: 0;    left: 0;    z-index: 100;    background: transparent;    color: transparent;  }  .table-header{    /*min-height: 200px;*/  }  .table-footer-seat{    height: 100px;  }  .table-footer{    min-height: 100px;  }  .table-footer{    position: fixed;    bottom: 0;    left: 0;    width: 100%;    z-index: 200;  }  .goExit{    position: absolute;    top: 40px;    right: 50px;    z-index: 100;  }</style>